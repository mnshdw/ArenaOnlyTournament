name: Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+-vn"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF_NAME}"
          BASE_VERSION="${VERSION%-vn}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "base=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Verify version matches mod file
        run: |
          set -eux
          BASE_VERSION="${{ steps.get_version.outputs.base }}"
          if ! grep -q "Version = \"$BASE_VERSION\"," scripts/!mods_preload/mod_arena_only_tournament.nut; then
            echo "Error: Version in tag base ($BASE_VERSION) does not match version in mod_arena_only_tournament.nut"
            exit 1
          fi
          echo "Version verification successful: $BASE_VERSION"

      - name: Build release zip
        run: |
          set -eux
          BASE_VERSION="${{ steps.get_version.outputs.base }}"
          ZIP_NAME="mod_arena_only_tournament_${BASE_VERSION}.zip"
          rm -f mod_arena_only_tournament*.zip
          zip -r "$ZIP_NAME" . -x 'release.sh' -x '*.git*' -x '*.zip*'
          echo "Created $ZIP_NAME"

      - name: Generate changelog
        run: |
          set -eux
          git fetch --force --tags
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"- %s%n%b" > changelog.txt
          else
            git log --pretty=format:"- %s%n%b" ${PREV_TAG}..HEAD > changelog.txt
          fi

          echo "Generated changelog:"
          cat changelog.txt

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          VERSION="${{ steps.get_version.outputs.version }}"
          BASE_VERSION="${{ steps.get_version.outputs.base }}"
          ZIP_NAME="mod_arena_only_tournament_${BASE_VERSION}.zip"

          gh release create "$VERSION" \
            "$ZIP_NAME" \
            --notes-file changelog.txt \
            --title "Arena Only Tournament $BASE_VERSION"

          echo "Release $VERSION created successfully!"
